name: Update Next.js Version

on:
  schedule:
    - cron: '0 0 * * *' # 매일 자정에 실행
  push:
    branches:
      - main
  workflow_dispatch: # 수동 트리거 허용

jobs:
  check-nextjs-version:
    runs-on: ubuntu-latest

    steps:
      - name: 리포지토리 체크아웃
        uses: actions/checkout@v2

      - name: Node.js 설정
        uses: actions/setup-node@v2
        with:
          node-version: '20' # Node.js 버전을 지정

      - name: pnpm 설치
        run: npm install -g pnpm

      - name: 의존성 설치
        run: pnpm install

      - name: 현재 Next.js 버전 확인
        id: current_version
        run: echo "::set-output name=version::$(pnpm list next | grep next@ | sed 's/.*next@//')"

      - name: 최신 Next.js 버전 확인
        id: latest_version
        run: echo "::set-output name=version::$(pnpm info next version)"

      - name: 버전 비교
        id: compare_versions
        run: |
          if [ "${{ steps.current_version.outputs.version }}" != "${{ steps.latest_version.outputs.version }}" ]; then
            echo "새 버전이 있습니다."
            echo "::set-output name=update_needed::true"
          else
            echo "업데이트가 필요하지 않습니다."
            echo "::set-output name=update_needed::false"
          fi

      - name: Next.js 버전 업데이트
        if: steps.compare_versions.outputs.update_needed == 'true'
        run: |
          git fetch origin main
          git checkout main
          git pull origin main
          git checkout -b update-nextjs
          pnpm add next@latest
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          pnpm install
          git add package.json pnpm-lock.yaml
          git commit -m "chore: update Next.js to ${{ steps.latest_version.outputs.version }}"
          git pull origin update-nextjs --rebase || git merge --abort
          git push https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git update-nextjs --force

      - name: 풀 리퀘스트 생성
        if: steps.compare_versions.outputs.update_needed == 'true'
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
          branch: update-nextjs
          base: main
          title: 'chore: update Next.js to ${{ steps.latest_version.outputs.version }}'
          body: 'This PR updates Next.js to version ${{ steps.latest_version.outputs.version }}.'
